# **Inital Setup & Configuration**

This section provides step-by-step guidance for installing ArgoCD along with the CLI and perform the inital configuration.

---

## #1 **Installation**

1.  Deployment with Helm

    ```bash
    helm repo add argo https://argoproj.github.io/argo-helm
    helm repo update
    helm upgrade --install --namespace argocd --create-namespace argo-cd argo/argo-cd
    helm list -A
    ```

1. Validation with k9s

    Check for ArgoCD Pods:

    ```
    ┌─────────────────────────────────── pods(argocd)[7] ────────────────────────────────────┐
    │ NAME↑                                                      PF READY STATUS   RESTARTS  │
    │ argo-cd-argocd-application-controller-0                    ●  1/1   Running         0  │
    │ argo-cd-argocd-applicationset-controller-55d766c678-6t8c2  ●  1/1   Running         0  │
    │ argo-cd-argocd-dex-server-df574f64-zglqr                   ●  1/1   Running         0  │
    │ argo-cd-argocd-notifications-controller-54f68bfcfb-v74fs   ●  1/1   Running         0  │
    │ argo-cd-argocd-redis-786d89cb4f-mfrpt                      ●  1/1   Running         0  │
    │ argo-cd-argocd-repo-server-5c76b85455-6mbzq                ●  1/1   Running         0  │
    │ argo-cd-argocd-server-68d4c9ff58-vkk4f                     ●  1/1   Running         0  │
    └────────────────────────────────────────────────────────────────────────────────────────┘
    ```

1. Expose ArgoCD WebUI & Login with Admin User

    1. Add `127.0.0.1 argocd.kind` to `C:\Windows\System32\drivers\etc\hosts`
    1. Update Helm deployment with enabled ingress and insecure server service
        ```bash
        helm upgrade --install --namespace argocd --create-namespace argo-cd argo/argo-cd --set global.domain=argocd.kind --set server.ingress.enabled=true --set 'configs.params.server\.insecure=true'
        ```
    1. Navigate with `k9s` to secrets in `argocd` namespace and decode the `argocd-initial-admin-secret`
    1. Open the WebUI: http://argocd.kind and login with `admin` user

1. Download & Install ArgoCD CLI

     ```powershell
     $version = (Invoke-RestMethod https://api.github.com/repos/argoproj/argo-cd/releases/latest).tag_name
     $url = "https://github.com/argoproj/argo-cd/releases/download/" + $version + "/argocd-windows-amd64.exe"
     Invoke-WebRequest -Uri $url -OutFile argocd.exe
     [Environment]::SetEnvironmentVariable("Path", "$env:Path;$pwd", "User")
     $env:Path = [System.Environment]::GetEnvironmentVariable("Path", "User")
     ```

    Verify installation by running:
    ```bash
    argocd version
    ```

1. Connect ArgoCD CLI to Server

    1. Log in using the CLI:
        ```bash
        argocd login argocd.kind:80 --insecure --username admin
        ```
    1. Try again to verify ArgoCD Server version:
        ```bash
        argocd version
        ```
    1. Change the default admin password for security:
        ```bash
        argocd account update-password
        ```

    1. Consider setting the environment variables
        ```powershell
        # PowerShell
        $env:ARGOCD_SERVER="argocd.kind"
        $env:ARGOCD_OPTS="--grpc-web"
        ```

1. Add your personal user to ArgoCD via Helm

    1. Create `argocd.values.yaml` with content:

        ```yaml
        global:
          domain: argocd.kind
          hostAliases:
            - ip: 10.133.201.171
              hostnames:
                - gitea.kind

        server:
          ingress:
            enabled: true

        configs:
          params:
            server.insecure: true

          cm:
            accounts.sergeiwaigant: login
            accounts.sergeiwaigant.enabled: "true"
        ```

    1. Rollout your user with helm, check for the user being present and update password with CLI:

        ```bash
        helm upgrade --install --namespace argocd --create-namespace argo-cd argo/argo-cd --values argocd.values.yaml

        argocd account list
          NAME           ENABLED  CAPABILITIES
          admin          true     login
          sergeiwaigant  true     login

        argocd account update-password --account sergeiwaigant
        ```

    1. Validate user login in another browser tab and check for permissions - e.g. view or create projects should fail

1. Change default policy with helm by adding to the values.yaml and validate with your user

    ```yaml
    configs:
      rbac:
        policy.default: role:readonly

    ```

1. Create custom role, assign privileges for your project and assign it to your user:

    ```yaml
    configs:
      rbac:
        policy.default: role:readonly
        policy.csv: |
          p, role:sergeiwaigant, projects, *, sergeiwaigant, allow
          p, role:sergeiwaigant, applications, *, sergeiwaigant/*, allow

          g, sergeiwaigant, role:sergeiwaigant
    ```

    Validate by creating the project `sergeiwaigant` and try to create an application through the UI. Application creation should fail and let's try to find out what's missing.

1. Add Credentials Template and Repository

    ```yaml
    configs:
      credentialTemplates:
        gitea-localhost:
          url: http://gitea.kind
          password: foobar123
          username: sergeiwaigant
      repositories:
        course-argocd:
          url: http://gitea.kind/sergeiwaigant/course-argocd
          type: git
          name: course-argocd
          project: sergeiwaigant
    ```

    Validate through the UI that the repository is successfully connected.

