# **Practical Exercise 4: Advanced Configuration and ApplicationSets**

This exercise focuses on implementing advanced features of ArgoCD, including **ApplicationSets**, **security practices**, and building a complete GitOps workflow. Below is the detailed content for each section.

---

1. **Adding two more kind cluster to ArgoCD**:
    - Create `kind.prod.yaml` & `kind.dev.yaml` and exec kind CLI:
      ```yaml
      kind: Cluster
      apiVersion: kind.x-k8s.io/v1alpha4
      name: production / development
      nodes:
      - role: control-plane
        extraPortMappings:
        - containerPort: 80
          hostPort: 8080 / 8081
        - containerPort: 443
          hostPort: 8443 / 8444
      ```
      ```bash
      kind create cluster --config kind.prod.yaml
      kind create cluster --config kind.dev.yaml
      ```
    - Validate access to the cluster with k9s and changing the context
    - Deploy Ingress Controller
        ```bash
        kubectl --context kind-production apply -f https://kind.sigs.k8s.io/examples/ingress/deploy-ingress-nginx.yaml
        kubectl --context kind-development apply -f https://kind.sigs.k8s.io/examples/ingress/deploy-ingress-nginx.yaml

        kubectl --context kind-production wait --namespace ingress-nginx --for=condition=ready pod --selector=app.kubernetes.io/component=controller --timeout=90s
        kubectl --context kind-development wait --namespace ingress-nginx --for=condition=ready pod --selector=app.kubernetes.io/component=controller --timeout=90s
        ```
    - Get the cluster IPs:
      ```bash
      kubectl --context kind-production get nodes -o jsonpath="{range .items[*]}{.metadata.name}{'\t'}{range .status.addresses[?(@.type=='InternalIP')]}{.address}{'\n'}{end}{end}"
      kubectl --context kind-development get nodes -o jsonpath="{range .items[*]}{.metadata.name}{'\t'}{range .status.addresses[?(@.type=='InternalIP')]}{.address}{'\n'}{end}{end}"
      ```
    - Open `$HOME/.kube/config` and fetch the required infos for `clusterCredentials`
    - Add `clusterCredentials` to argocd.values.yaml, rollout with helm... beware... there are issues in the below config that has to be fixed
      ```yaml
      clusterCredentials:
        production:
          server: http://production.ip:6443
          labels: {}
          annotations: {}
          config:
            tlsClientConfig:
              insecure: false
              caData: "<base64 encoded certificate>"
          certData: "<base64 encoded certificate>"
          keyData: "<base64 encoded certificate>"
        development:
          server: http://development.ip:6443
          labels: {}
          annotations: {}
          config:
            tlsClientConfig:
              insecure: false
              caData: "<base64 encoded certificate>"
          certData: "<base64 encoded certificate>"
          keyData: "<base64 encoded certificate>"
      ```
      ```bash
      helm --kube-context kind-argocd upgrade --install --namespace argocd --create-namespace argo-cd argo/argo-cd --values argocd.values.yaml
      ```
    - Create demo apps and validate cluster has been created:
      ```bash
        argocd app create demo-nginx-production \
          --repo http://gitea.kind/sergeiwaigant/gitops-argocd.git \
          --path apps/demo-nginx \
          --directory-exclude application.yaml \
          --dest-name production \
          --dest-namespace default \
          --sync-policy manual

        argocd app create demo-nginx-development \
          --repo http://gitea.kind/sergeiwaigant/gitops-argocd.git \
          --path apps/demo-nginx \
          --directory-exclude application.yaml \
          --dest-name development \
          --dest-namespace default \
          --sync-policy manual
      ```

1. **Creating Multi-Environment Helm Deployment**

    - Use the `ApplicationSet` CRD to dynamically generate multiple `Application` resources based on environment-specific parameters.
    - Extend `app-of-apps` to include `*/applicationset.yml,*/applicationset.yaml`
    - Create YAML for multi-environment deployment `apps/podinfo/applicationset.yaml`
      ```yaml
      apiVersion: argoproj.io/v1alpha1
      kind: ApplicationSet
      metadata:
        name: podinfo
        namespace: argocd
      spec:
        generators:
          - list:
              elements:
                - cluster: development
                  chart-version: 6.8.0
                - cluster: production
                  chart-version: 6.8.0
        template:
          metadata:
            name: 'podinfo-{{ cluster }}'
            namespace: argocd
          spec:
            project: default
            sources:
              - repoURL: https://stefanprodan.github.io/podinfo
                targetRevision: '{{ chart-version }}'
                helm:
                  valueFiles:
                    - $values/apps/podinfo/values.yaml
                chart: podinfo
              - repoURL: http://gitea.kind/sergeiwaigant/gitops-argocd.git
                targetRevision: HEAD
                ref: values
            destination:
              name: '{{ cluster }}'
              namespace: podinfo
            syncPolicy:
              syncOoptions:
                - CreateNamespace=true
              automated:
                prune: true
                selfHeal: true
      ```
    - Validate access via
      - http://podinfo.kind:80
      - http://podinfo.kind:8080
      - http://podinfo.kind:8081

1. **Setting Up Project Restrictions**

    - Restrict source repositories and destination clusters/namespaces within a project definition.
    - Create new projects for development and production by adding `projects/<development|production>.yaml`
      ```yaml
      apiVersion: argoproj.io/v1alpha1
      kind: AppProject
      metadata:
        name: development / production
        namespace: argocd
      spec:
        sourceRepos:
          - '*'
        destinations:
          - name: development / production
            namespace: '*'
        clusterResourceWhitelist:
          - group: "*"
            kind: "*"
      ```
    - Create a new app for creating the projects
        ```bash
        argocd app create app-projects \
          --repo http://gitea.kind/sergeiwaigant/gitops-argocd.git \
          --path projects \
          --dest-server https://kubernetes.default.svc \
          --sync-policy automated \
          --sync-option Prune=false \
          --sync-option selfHeal=true
        ```
    - Adjust `apps/podinfo/applicationset.yaml` to create apps in the correct projects
    - Verify changed project assignments for podinfo apps

1. **Sync Windows**:

    Refer to the documentation for further details: https://argo-cd.readthedocs.io/en/stable/user-guide/sync_windows/

    - Adjust `projects/production.yaml` and add the `syncWindows`
      ```yaml
      spec:
        syncWindows:
        - kind: allow
          schedule: '10 1 * * *'
          duration: 1h
          clusters:
          - production
          namespaces:
          - '*'
          applications:
          - '*'
      ```
    - Adjust `apps/podinfo/applicationset.yaml` and add:
      ```yaml
      spec.template.spec.sources[0].helm:
        valuesObject:
          ui:
            message: '{{ cluster }}'
      ```
    - Validate the sync windows in the ArgoCD WebUI and try to sync to production
    - Configure the sync window to allow manual sync and try again

1. **App Deletion**:

1. **Resource Hooks**:

1. **Git Webhooks**:

1. **Secret Management**:

    Argo CD is un-opinionated about how secrets are managed. There are many ways to do it, and there's no one-size-fits-all solution.

    Refer to the documentation for further details: https://argo-cd.readthedocs.io/en/stable/operator-manual/secret-management/

1. **Notifications**:

    Argo CD Notifications continuously monitors Argo CD applications and provides a flexible way to notify users about important changes in the application state.

    Refer to the documentation for further details: https://argo-cd.readthedocs.io/en/stable/operator-manual/notifications/

1. **Continue adapting GitOps**:

    - [What Is GitOps? How Git Can Make DevOps Even Better](https://codefresh.io/learn/gitops/)
    - [The pains of GitOps 1.0](https://codefresh.io/blog/pains-gitops-1-0/)
    - [Stop Using Branches for Deploying to Different GitOps Environments](https://codefresh.io/blog/stop-using-branches-deploying-different-gitops-environments/)
    - [How to Model Your GitOps Environments and Promote Releases between Them](https://codefresh.io/blog/how-to-model-your-gitops-environments-and-promote-releases-between-them/)
    - [How to Structure Your Argo CD Repositories Using Application Sets](https://codefresh.io/blog/how-to-structure-your-argo-cd-repositories-using-application-sets/)
