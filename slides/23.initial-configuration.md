# Initial Configuration

## **Authentication and User Management**

ArgoCD comes with a default `admin` user that has full access to the system. It is recommended to use this account only for initial setup and then disable it for security purposes. You can create additional local users or integrate Single Sign-On (SSO) with third-party providers like LDAP, SAML, or OAuth. Local users are defined in the `argocd-cm` ConfigMap, where you can specify their capabilities (e.g., API key generation or UI login). For automation or small teams, local users may suffice, but enterprise setups should use SSO for advanced features like group-based access.

**Steps for Local User Management**:
1. Define new users in the `argocd-cm` ConfigMap:
    ```yaml
    data:
      accounts.<username>: apiKey, login
      accounts.<username>.enabled: "true"
    ```
2. Disable the default admin user:
    ```yaml
    data:
      admin.enabled: "false"
    ```
3. Use the CLI to manage users:
    - Note: There is no way to create users with the CLI, only updating passwords
    - List users: `argocd account list`
    - Set user password: `argocd account update-password --account`

---

## **RBAC Configuration**

Role-Based Access Control (RBAC) in ArgoCD ensures least privilege access by defining roles and policies within the `argocd-rbac-cm` ConfigMap. By default, ArgoCD provides two roles: `admin` (full access) and `readonly` (view-only access). You can create custom roles and associate them with specific groups or users. Policies are defined in CSV format, specifying which actions are allowed for each role.

**Steps to Configure RBAC**:
1. Edit the `argocd-rbac-cm` ConfigMap to define policies:
    ```yaml
    data:
      policy.csv: |
        g, developers, role:readonly
        g, admins, role:admin
    ```
2. Associate groups with roles using the format:

    Example: `g, argocdusers, role:readonly`

3. Set a default policy for authenticated users:
    ```yaml
    data:
      policy.default: role:readonly
    ```

Refer to the documentation for further details: https://argo-cd.readthedocs.io/en/stable/operator-manual/rbac/#rbac-model-structure

---

## Add `gitea` to machine and pod host aliases

When using a self-hosted gitea instance in the course, it might be helpful to add a host alias to the pod.

Update the Helm deployment with added host aliases

    ```bash
    helm upgrade --install --namespace argocd --create-namespace argo-cd argo/argo-cd \
      --set global.domain=argocd.kind \
      --set server.ingress.enabled=true \
      --set 'configs.params.server\.insecure=true' \
      --set 'global.hostAliases[0].ip="192.168.141.20",global.hostAliases[0].hostnames[0]="gitea.kind"'
    ```

## **Repository Connections**

ArgoCD supports integration with both public and private Git repositories using HTTPS or SSH credentials. Private repositories require authentication credentials such as username/password or SSH keys. These credentials can be configured via the CLI or UI under the "Settings > Repositories" section.

Refer to the documentation for further instructions: https://argo-cd.readthedocs.io/en/stable/user-guide/private-repositories/

**Steps to Connect Repositories**:
1. Add repositories via CLI:
    - HTTPS example:
      ```bash
      argocd repo add http://gitea.kind/sergeiwaigant/course-argocd --type git --name course-argocd --upsert --username sergeiwaigant
      ```
    - SSH example:
      ```bash
      argocd repo add git@github.com:sergeiwaigant/course-argocd.git --ssh-private-key-path ~/.ssh/id_rsa
      ```
1. Use credential templates for multiple repositories under a domain:
    ```bash
    argocd repocreds add http://gitea.kind/ --username sergeiwaigant
    ```
1. Verify connection via UI or CLI.

## Repository certificates and known hosts

- For adding private repositories, adding self-signed and untrusted TLS certificates to ArgoCD might be required.
- Same can be required for privately hosted Git services over SSH and adding the SSH known hosts
- Refer to the documentation for further instructions:<br>https://argo-cd.readthedocs.io/en/stable/user-guide/private-repositories/#self-signed-untrusted-tls-certificates

## **GnuPG Keys**

Git commit signing is a way to ensure, that you can verify if a commit has been made by a legit source. For ArgoCD to be able to verify these commit and instruct ArgoCD to only consider commits that has been signed by a trusted source, you have to add either each individual signing certificate or the root of the certificates.

Refer to the documentation for further instructions:<br>https://argo-cd.readthedocs.io/en/stable/user-guide/gpg-verification/

## Configuration through helm

Since we are talking GitOps, why not use same declarative methods to configure ArgocD with the already used helm chart?

Find all available configs and defaults in the `values.yaml`: https://github.com/argoproj/argo-helm/blob/main/charts/argo-cd/values.yaml

1. Add `credentialsTemplates`
    ```yaml
    configs:
      credentialTemplates:
        https-creds:
          url: http://gitea.kind/argoproj
          password: my-password
          username: my-username
      repositories:
        private-repo:
          url: http://gitea.kind/argoproj/private-repo
          type: git
          project: default
          name: course-argocd
    ```

## Dex IdP

By default, the installation through Helm deploys the Dex IdP for SSO integration.

Refer to the documentation for further instructions: https://argo-cd.readthedocs.io/en/stable/operator-manual/user-management/#sso
