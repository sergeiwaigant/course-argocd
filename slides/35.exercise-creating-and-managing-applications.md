# **Creating and Managing Applications in ArgoCD**

This section provides step-by-step guidance for creating a sample application, configuring it in ArgoCD, performing synchronization, and implementing updates and rollbacks.

---

1. **Creating `demo-nginx` application**:
    - **...via UI**:
      - Access the ArgoCD UI with `admin` and click on `+ NEW APP`.
      - Fill in details:
        - application name: `demo-nginx`
        - project: `default`
        - repository URL: 
        - path to manifests: `.`
        - cluster URL: `https://kubernetes.default.svc`
        - namespace `default`
        - sync policy: `manual`

    - **... via CLI**:
      - Use the `argocd app create` command to define applications declaratively.
      - Example command:
        ```bash
        argocd app create demo-nginx \
          --repo http://gitea.kind/sergeiwaigant/gitops-argocd.git \
          --path . \
          --dest-server https://kubernetes.default.svc \
          --dest-namespace default \
          --sync-policy manual
        ```

    - Check the app in ArgoCD WebUI, browse the details, events, etc. to get familiar with the overview 

1. **Defining Application Deployment Manifests**:
    - Application manifests are YAML files that define Kubernetes resources (e.g., Deployments, Services).
    - Create a simple Nginx deployment as `demo-nginx.yaml` in the Git repository
      ```yaml
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: nginx
        labels:
          app: nginx
      spec:
        replicas: 3
        selector:
          matchLabels:
            app: nginx
        template:
          metadata:
            labels:
              app: nginx
          spec:
            containers:
            - name: nginx
              image: nginx:latest
              ports:
              - containerPort: 80
      ```
1. **Verify Deployment in ArgoCD UI and k9s**
    - Click `refresh` to trigger a `git pull/fetch` within the repo server
    - Check the diff and events to understand the flow
    - Trigger the sync by manually clicking `sync` leaving the options in default
    - Verify the deployment in k9s

1. **Default refresh interval**:
    - The default interval for checking for changes in git and helm is 180s / 3 minutes and can be changed with `timeout.reconciliation` in `argocd-cm`
    - Be careful with this option and consider using other methods like webhooks in bigger environments as this might add a serious load on ArgoCD
    - https://argo-cd.readthedocs.io/en/stable/faq/#how-often-does-argo-cd-check-for-changes-to-my-git-or-helm-repository
    - Create `gitea.values.yaml` and run helm upgrade install
      ```yaml
      ingress:
        enabled: true
        hosts:
          - host: gitea.kind
            paths:
              - path: /
                pathType: ImplementationSpecific

      global:
        hostAliases:
          - ip: 172.18.0.2
            hostnames:
              - argocd.kind

      gitea:
        config:
          webhook:
            ALLOWED_HOST_LIST: argocd.kind
      ```
      ```bash
      helm upgrade --install --namespace gitea --create-namespace gitea oci://docker.gitea.com/charts/gitea --values gitea.values.yaml
      ```
    - Navigate in http://gitea.kind/ to your repository into the settings > webhooks
    - Add a new webhook for:
      - URL: http://argocd.kind/api/webhook
      - Method: POST
      - All rest can stay in default
      - Click the "send test" button to check the connection
    - Now all pushes to the repository should trigger a webhook to ArgoCD to trigger the refresh for this particular repository

1. **Reduce the replicas and add a service**:
    - Adjust the `demo-nginx.yaml` and reduce the replicas to 2
    - Add the following service to the same file:
      ```yaml
      apiVersion: v1
      kind: Service
      metadata:
        name: nginx
      spec:
        ports:
        - name: http
          port: 80
          protocol: TCP
        selector:
          app.kubernetes.io/name: nginx
        type: ClusterIP
      ```
    - Use the ArgoCD CLI for refreshing, diff and sync
      ```bash
      # trigger polling the git repository
      argocd app get demo-nginx --refresh

      # check the status of the app in json / tree / wide style
      argocd app get demo-nginx -o tree
      argocd app get demo-nginx -o wide
      argocd app get demo-nginx -o json

      # check the diff
      argocd app diff demo-nginx

      # trigger sync for the deployment only
      argocd app sync demo-nginx --resource apps:Deployment:nginx

      # trigger sync for the service only
      argocd app sync demo-nginx --resource :Service:nginx
      ```

    - Refer to the documentation for further instructions:
      - get: https://argo-cd.readthedocs.io/en/stable/user-guide/commands/argocd_app_get/
      - sync: https://argo-cd.readthedocs.io/en/stable/user-guide/commands/argocd_app_sync/

1. **Handle `kubectl.kubernetes.io/last-applied-configuration`**:
    - Check the Live Manifests in ArgoCD / k9s and find the annotation
    - Add the sync options "Server Side Apply" to the app and sync the app once
    - Add the annotation back to just the deployment by adjusting the demo-nginx.yaml and add:
      ```yaml
      metadata:
        annotations:
          argocd.argoproj.io/sync-options: ServerSideApply=false
      ```
    - Verify the behavior in ArgoCD / k9s

1. **Add another app**:
    - Add another deployment `demo-nginx2.yaml`
      ```yaml
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: nginx2
        labels:
          app: nginx2
      spec:
        replicas: 2
        selector:
          matchLabels:
            app: nginx2
        template:
          metadata:
            labels:
              app: nginx2
          spec:
            containers:
            - name: nginx
              image: nginx:latest
              ports:
              - containerPort: 80
      ```
    - Refresh and sync the app

1. **Rollback the app**:
    - Rollback the app to the state before adding the `service` to `demo-nginx`

    - Via UI:
      - Browse to the app and use `History and Rollback` function to rollback to initial commit
      - Check the behavior and status after rollback

    - Via CLI:
      ```bash
      # list the history and select the correct ID
      argocd app history demo-nginx

      # rollback the app to the ID with prune option
      argocd app rollback demo-nginx 13 --prune
      ```

1. **Structuring the Repository**:
    - Organize manifests in a Git repository using a clear directory structure.
    - Restructure the repository like below:
      ```
      ├── apps/
          ├── demo-nginx/
              ├── deployment.yaml
              ├── service.yaml
          ├── demo-nginx2/
              ├── deployment.yaml
      ```
    - Adjust the first app to take manifests from `apps/demo-nginx` and create another app for manifests from `apps/demo-nginx2`

1. **Move `podinfo` helm deployment to ArgoCD**:
    - Delete podinfo helm and namespace in k9s
    - Create a new app and sync via CLI:
      ```bash
      argocd app create podinfo --repo https://stefanprodan.github.io/podinfo --helm-chart podinfo --revision 6.8.0 --dest-namespace podinfo --dest-server https://kubernetes.default.svc
      argocd app sync podinfo
      ```
    - Validate the error message and add the correct sync option to the app with `argocd app set`
    - Check k9s for the helm summary of podinfo - why will you not be able to find it? Check for the answer here: https://argo-cd.readthedocs.io/en/latest/user-guide/helm/
    - Add the missing values to the app and check for http://podinfo.kind

1. **Deleting resources from Kubernetes and self-heal**:
    - Delete the podinfo ingress via k9s and check the app in ArgoCD UI
    - Enable `auto-sync` + `self-heal` on the app in ArgoCD UI and see the automatic re-create of ingress object
    - Delete the ingress again and see the status in ArgoCD UI

1. **Let's create apps with apps**:
    - This approach is called the app of apps pattern: https://argo-cd.readthedocs.io/en/latest/operator-manual/cluster-bootstrapping/#app-of-apps-pattern
    - Create a new app
      ```bash
      argocd app create app-of-apps \
        --repo http://gitea.kind/sergeiwaigant/gitops-argocd.git \
        --path apps \
        --dest-server https://kubernetes.default.svc \
        --sync-policy automated \
        --sync-option Prune=true \
        --sync-option selfHeal=true
      ```
    - Add the file `apps/demo-nginx.yaml`
      ```yaml
      apiVersion: argoproj.io/v1alpha1
      kind: Application
      metadata:
        name: demo-nginx
        namespace: argocd
      spec:
        project: default
        source:
          repoURL: http://gitea.kind/sergeiwaigant/gitops-argocd
          path: apps/nginx
          targetRevision: HEAD
        destination:
          server: https://kubernetes.default.svc
          namespace: default
        syncPolicy:
          syncOptions:
            - ServerSideApply=true
      ```
    - Change the destination namespace from `default` to `demo-nginx` and add `CreateNamespace=true` to syncOptions
    - Verify the behaviour in ArgoCD WebUI and see the demo-nginx deployment moving to another namespace
    - Move all apps to the repository

1. **Thinking big... this is getting clunky, let's optimize**:
    - Update app-of-apps to search recursive for application yaml files
      ```bash
      argocd app set app-of-apps --directory-recurse --directory-include "{application.yml,application.yaml}"
      ```
    - Check the health of the apps... they should be all out of sync - dont trigger the sync!
    - Move the application yamls to the respective directories and see how the apps self heal
    - Consider adding directory-exclude for application.yml/yaml to the directory type applications to avoid conflicts with app-of-apps

1. **Move helm values to file**:
    - Note the Helm value presedence order: https://argo-cd.readthedocs.io/en/latest/user-guide/helm/#helm-value-precedence
    - Add `apps/podinfo/values.yaml`:
      ```yaml
      ingress:
        enabled: true
        hosts:
          - host: podinfo.kind
            paths:
              - path: /
                pathType: ImplementationSpecific
      ```
    - Adjust `apps/podinfo/application.yaml` and replace `spec.source.helm.parameters` with `spec.source.helm.valueFiles[0]=values.yaml`
    - Why is ArgoCD deleting the ingress resource? Seems like the `values.yaml` is getting ignored...
    - Check the multiple sources feature: https://argo-cd.readthedocs.io/en/latest/user-guide/multiple_sources/
